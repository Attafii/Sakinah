<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakinah Settings Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        h1 { text-align: center; margin-bottom: 30px; }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .test-section h2 {
            margin-top: 0;
            font-size: 1.2rem;
            color: #A8EBD8;
        }
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .test-name {
            font-weight: 600;
            flex: 1;
        }
        .test-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-pass { background: #10b981; color: white; }
        .status-fail { background: #ef4444; color: white; }
        .status-pending { background: #f59e0b; color: white; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #72BAAE;
            color: white;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }
        .btn:hover { background: #2B8C7B; }
        .output {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üïå Sakinah Settings Test Suite</h1>
    
    <div class="controls">
        <button class="btn" id="test-all">Run All Tests</button>
        <button class="btn" id="open-settings">Open Settings</button>
        <button class="btn" id="open-newtab">Open New Tab</button>
        <button class="btn" id="clear-storage">Clear All Storage</button>
    </div>

    <div class="test-section">
        <h2>‚úÖ Storage Tests</h2>
        <div id="storage-tests">
            <div class="test-item">
                <span class="test-name">CONFIG.DEFAULT_SETTINGS exists</span>
                <span class="test-status status-pending" id="status-config">Pending</span>
            </div>
            <div class="test-item">
                <span class="test-name">chrome.storage.sync.get works</span>
                <span class="test-status status-pending" id="status-storage-get">Pending</span>
            </div>
            <div class="test-item">
                <span class="test-name">chrome.storage.sync.set works</span>
                <span class="test-status status-pending" id="status-storage-set">Pending</span>
            </div>
            <div class="test-item">
                <span class="test-name">Settings persist after reload</span>
                <span class="test-status status-pending" id="status-persist">Pending</span>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>‚öôÔ∏è Settings Functionality</h2>
        <div id="settings-tests">
            <div class="test-item">
                <span class="test-name">New Tab Toggle (enable/disable)</span>
                <span class="test-status status-pending" id="status-newtab-toggle">Pending</span>
            </div>
            <div class="test-item">
                <span class="test-name">Ecosystem Selection</span>
                <span class="test-status status-pending" id="status-ecosystem">Pending</span>
            </div>
            <div class="test-item">
                <span class="test-name">Theme Mode</span>
                <span class="test-status status-pending" id="status-theme">Pending</span>
            </div>
            <div class="test-item">
                <span class="test-name">Prayer Times Location</span>
                <span class="test-status status-pending" id="status-prayer">Pending</span>
            </div>
            <div class="test-item">
                <span class="test-name">Notification Settings</span>
                <span class="test-status status-pending" id="status-notifications">Pending</span>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üîî Background Script Tests</h2>
        <div id="background-tests">
            <div class="test-item">
                <span class="test-name">Background script loaded</span>
                <span class="test-status status-pending" id="status-bg-loaded">Pending</span>
            </div>
            <div class="test-item">
                <span class="test-name">Notification alarms created</span>
                <span class="test-status status-pending" id="status-alarms">Pending</span>
            </div>
            <div class="test-item">
                <span class="test-name">Test notification sends</span>
                <span class="test-status status-pending" id="status-test-notif">Pending</span>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üìä Test Output</h2>
        <div class="output" id="test-output">Click "Run All Tests" to begin...</div>
    </div>

    <script src="config.js"></script>
    <script>
        const output = document.getElementById('test-output');
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            output.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
            testResults.push({ timestamp, type, message });
        }

        function updateStatus(id, passed) {
            const el = document.getElementById(id);
            if (el) {
                el.className = `test-status ${passed ? 'status-pass' : 'status-fail'}`;
                el.textContent = passed ? 'PASS' : 'FAIL';
            }
        }

        async function testConfig() {
            log('Testing CONFIG object...');
            try {
                if (typeof CONFIG === 'undefined') {
                    throw new Error('CONFIG is undefined');
                }
                if (!CONFIG.DEFAULT_SETTINGS) {
                    throw new Error('CONFIG.DEFAULT_SETTINGS is undefined');
                }
                log(`‚úÖ CONFIG.DEFAULT_SETTINGS has ${Object.keys(CONFIG.DEFAULT_SETTINGS).length} settings`, 'success');
                updateStatus('status-config', true);
                return true;
            } catch (e) {
                log(`‚ùå CONFIG test failed: ${e.message}`, 'error');
                updateStatus('status-config', false);
                return false;
            }
        }

        async function testStorageGet() {
            log('Testing chrome.storage.sync.get...');
            try {
                const settings = await chrome.storage.sync.get(CONFIG.DEFAULT_SETTINGS);
                log(`‚úÖ Retrieved ${Object.keys(settings).length} settings`, 'success');
                log(`   newTabEnabled: ${settings.newTabEnabled}`, 'info');
                log(`   primaryEcosystem: ${settings.primaryEcosystem}`, 'info');
                log(`   theme: ${settings.theme}`, 'info');
                updateStatus('status-storage-get', true);
                return true;
            } catch (e) {
                log(`‚ùå Storage get failed: ${e.message}`, 'error');
                updateStatus('status-storage-get', false);
                return false;
            }
        }

        async function testStorageSet() {
            log('Testing chrome.storage.sync.set...');
            try {
                const testValue = { testKey: 'testValue_' + Date.now() };
                await chrome.storage.sync.set(testValue);
                
                const result = await chrome.storage.sync.get('testKey');
                if (result.testKey === testValue.testKey) {
                    log(`‚úÖ Storage set/get verified`, 'success');
                    updateStatus('status-storage-set', true);
                    return true;
                } else {
                    throw new Error('Value mismatch');
                }
            } catch (e) {
                log(`‚ùå Storage set failed: ${e.message}`, 'error');
                updateStatus('status-storage-set', false);
                return false;
            }
        }

        async function testPersistence() {
            log('Testing settings persistence...');
            try {
                // Set a test value
                await chrome.storage.sync.set({ newTabEnabled: true });
                
                // Read it back
                const result = await chrome.storage.sync.get('newTabEnabled');
                if (result.newTabEnabled === true) {
                    log(`‚úÖ Settings persist correctly`, 'success');
                    updateStatus('status-persist', true);
                    return true;
                } else {
                    throw new Error('Value not persisted');
                }
            } catch (e) {
                log(`‚ùå Persistence test failed: ${e.message}`, 'error');
                updateStatus('status-persist', false);
                return false;
            }
        }

        async function testNewTabToggle() {
            log('Testing New Tab toggle...');
            try {
                // Test enabling
                await chrome.storage.sync.set({ newTabEnabled: true });
                let result = await chrome.storage.sync.get('newTabEnabled');
                if (result.newTabEnabled !== true) throw new Error('Enable failed');
                
                // Test disabling
                await chrome.storage.sync.set({ newTabEnabled: false });
                result = await chrome.storage.sync.get('newTabEnabled');
                if (result.newTabEnabled !== false) throw new Error('Disable failed');
                
                // Restore to true
                await chrome.storage.sync.set({ newTabEnabled: true });
                
                log(`‚úÖ New Tab toggle works`, 'success');
                updateStatus('status-newtab-toggle', true);
                return true;
            } catch (e) {
                log(`‚ùå New Tab toggle failed: ${e.message}`, 'error');
                updateStatus('status-newtab-toggle', false);
                return false;
            }
        }

        async function testEcosystem() {
            log('Testing Ecosystem selection...');
            try {
                const ecosystems = ['google', 'microsoft', 'apple'];
                for (const eco of ecosystems) {
                    await chrome.storage.sync.set({ primaryEcosystem: eco });
                    const result = await chrome.storage.sync.get('primaryEcosystem');
                    if (result.primaryEcosystem !== eco) {
                        throw new Error(`Failed to set ${eco}`);
                    }
                }
                log(`‚úÖ Ecosystem selection works for all 3 options`, 'success');
                updateStatus('status-ecosystem', true);
                return true;
            } catch (e) {
                log(`‚ùå Ecosystem test failed: ${e.message}`, 'error');
                updateStatus('status-ecosystem', false);
                return false;
            }
        }

        async function testTheme() {
            log('Testing Theme mode...');
            try {
                const themes = ['auto', 'light', 'dark'];
                for (const theme of themes) {
                    await chrome.storage.sync.set({ theme: theme });
                    const result = await chrome.storage.sync.get('theme');
                    if (result.theme !== theme) {
                        throw new Error(`Failed to set ${theme}`);
                    }
                }
                log(`‚úÖ Theme mode works for all 3 options`, 'success');
                updateStatus('status-theme', true);
                return true;
            } catch (e) {
                log(`‚ùå Theme test failed: ${e.message}`, 'error');
                updateStatus('status-theme', false);
                return false;
            }
        }

        async function testPrayerTimes() {
            log('Testing Prayer Times settings...');
            try {
                await chrome.storage.sync.set({ 
                    prayerCity: 'London',
                    prayerCountry: 'GB',
                    prayerMethod: '3'
                });
                const result = await chrome.storage.sync.get(['prayerCity', 'prayerCountry', 'prayerMethod']);
                if (result.prayerCity !== 'London' || result.prayerCountry !== 'GB' || result.prayerMethod !== '3') {
                    throw new Error('Values not saved correctly');
                }
                log(`‚úÖ Prayer Times settings work`, 'success');
                updateStatus('status-prayer', true);
                return true;
            } catch (e) {
                log(`‚ùå Prayer Times test failed: ${e.message}`, 'error');
                updateStatus('status-prayer', false);
                return false;
            }
        }

        async function testNotifications() {
            log('Testing Notification settings...');
            try {
                await chrome.storage.sync.set({
                    notificationsEnabled: true,
                    notificationType: 'interval',
                    notificationInterval: 60,
                    quietHoursStart: '22:00',
                    quietHoursEnd: '07:00'
                });
                const result = await chrome.storage.sync.get([
                    'notificationsEnabled',
                    'notificationType',
                    'notificationInterval',
                    'quietHoursStart',
                    'quietHoursEnd'
                ]);
                
                if (result.notificationsEnabled !== true ||
                    result.notificationType !== 'interval' ||
                    result.notificationInterval !== 60) {
                    throw new Error('Values not saved correctly');
                }
                
                log(`‚úÖ Notification settings work`, 'success');
                updateStatus('status-notifications', true);
                return true;
            } catch (e) {
                log(`‚ùå Notification test failed: ${e.message}`, 'error');
                updateStatus('status-notifications', false);
                return false;
            }
        }

        async function testBackgroundScript() {
            log('Testing Background script...');
            try {
                // Try to send a message to the background script
                const response = await chrome.runtime.sendMessage({ action: 'ping' });
                log(`‚úÖ Background script is responsive`, 'success');
                updateStatus('status-bg-loaded', true);
                return true;
            } catch (e) {
                log(`‚ö†Ô∏è Background script may not be responding (this is okay if using a fallback)`, 'info');
                updateStatus('status-bg-loaded', false);
                return false;
            }
        }

        async function testAlarms() {
            log('Testing Notification alarms...');
            try {
                // Request background to update alarms
                await chrome.runtime.sendMessage({ action: 'updateAlarms' });
                
                // Check if any alarms exist
                const alarms = await chrome.alarms.getAll();
                log(`‚úÖ Found ${alarms.length} active alarms`, 'success');
                updateStatus('status-alarms', alarms.length > 0);
                return alarms.length > 0;
            } catch (e) {
                log(`‚ùå Alarms test failed: ${e.message}`, 'error');
                updateStatus('status-alarms', false);
                return false;
            }
        }

        async function testNotification() {
            log('Testing Test notification...');
            try {
                await chrome.runtime.sendMessage({ action: 'sendTestNotification' });
                log(`‚úÖ Test notification sent`, 'success');
                updateStatus('status-test-notif', true);
                return true;
            } catch (e) {
                log(`‚ùå Test notification failed: ${e.message}`, 'error');
                updateStatus('status-test-notif', false);
                return false;
            }
        }

        async function runAllTests() {
            output.innerHTML = 'üöÄ Starting test suite...\n\n';
            testResults = [];

            // Storage Tests
            await testConfig();
            await testStorageGet();
            await testStorageSet();
            await testPersistence();

            // Settings Tests
            await testNewTabToggle();
            await testEcosystem();
            await testTheme();
            await testPrayerTimes();
            await testNotifications();

            // Background Tests
            await testBackgroundScript();
            await testAlarms();
            await testNotification();

            log('\n=================================');
            log('‚úÖ Test suite completed!', 'success');
            const passed = testResults.filter(r => r.type === 'success').length;
            const failed = testResults.filter(r => r.type === 'error').length;
            log(`Results: ${passed} passed, ${failed} failed`, 'info');
        }

        // Event Listeners
        document.getElementById('test-all').addEventListener('click', runAllTests);
        
        document.getElementById('open-settings').addEventListener('click', () => {
            chrome.runtime.openOptionsPage();
        });
        
        document.getElementById('open-newtab').addEventListener('click', () => {
            chrome.tabs.create({ url: 'chrome://newtab' });
        });
        
        document.getElementById('clear-storage').addEventListener('click', async () => {
            if (confirm('This will clear ALL settings. Continue?')) {
                await chrome.storage.sync.clear();
                await chrome.storage.local.clear();
                log('üóëÔ∏è All storage cleared', 'info');
            }
        });

        // Auto-run tests on load
        log('Test page loaded. Ready to run tests.', 'info');
    </script>
</body>
</html>
